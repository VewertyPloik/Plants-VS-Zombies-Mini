<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini PvZ-like</title>
<style>
  html,body{height:100%;margin:0;background:linear-gradient(#a9e4ff,#dff7ff);font-family: Arial, Helvetica, sans-serif;}
  #ui{display:flex;gap:12px;align-items:center;padding:8px;background:rgba(255,255,255,0.8);border-bottom:2px solid #ccc}
  button{font-size:16px;padding:6px 10px;border-radius:6px;border:1px solid #888;cursor:pointer;background:white}
  #game{display:flex;gap:8px;padding:12px}
  #leftPanel{width:220px}
  #canvasWrap{background:linear-gradient(#76c24d,#4aa02b);padding:8px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.2)}
  canvas{background:linear-gradient(#7adf3b,#3fb011);display:block;border-radius:6px}
  .shopItem{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .cost{font-weight:bold}
  #message{margin-top:8px;padding:8px;background:rgba(255,255,255,0.9);border-radius:6px}
  #waveText{font-weight:bold}
</style>
</head>
<body>
<div id="ui">
  <div id="sunCount">‚òÄÔ∏è Sun: <span id="sunVal">5</span></div>
  <div id="waveText">Wave: 1 / 20</div>
  <div id="status">Status: Preparing</div>
</div>
<div id="game">
  <div id="leftPanel">
    <div class="shopItem"><button id="selectPea">ü´õ Pea Shooter<br><span class="cost">Cost: 3</span></button></div>
    <div class="shopItem"><button id="selectSunflower">üåª Sunflower<br><span class="cost">Cost: 2</span></button></div>
    <div class="shopItem"><button id="selectPie">ü•ß Pie Bomb<br><span class="cost">Cost: 4</span></button></div>
    <div class="shopItem"><button id="selectUpPea">ü´õ (Upgraded)<br><span class="cost">Cost: 5</span></button></div>
    <div id="message">Place plants by selecting a button, then clicking a grid cell. Click ‚òÄÔ∏è to collect.</div>
  </div>
  <div id="canvasWrap">
    <canvas id="c" width="900" height="500"></canvas>
  </div>
</div>
<script>
const ROWS=5,COLS=9,CELL_W=90,CELL_H=90,GRID_X=10,GRID_Y=10,START_SUN=5,TOTAL_WAVES=20;
let sun=START_SUN,currentWave=1,preparing=true,prepareTimer=5000,waveActive=false,selected=null;
let grid=Array.from({length:ROWS},()=>Array(COLS).fill(null)),suns=[],projectiles=[],zombies=[],tractor=null;
let lastTick=performance.now(),lastSunDrop=0,lastZombieSpawn=0,zombiesSpawned=0,zombiesToSpawn=0;
const sunVal=document.getElementById('sunVal'),waveText=document.getElementById('waveText'),status=document.getElementById('status');
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');

const costs={pea:3,sun:2,pie:4,uppea:5};
document.getElementById('selectPea').onclick=()=>selected='pea';
document.getElementById('selectSunflower').onclick=()=>selected='sun';
document.getElementById('selectPie').onclick=()=>selected='pie';
document.getElementById('selectUpPea').onclick=()=>selected='uppea';

canvas.addEventListener('click',e=>{
  const rect=canvas.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const x=GRID_X+c*CELL_W,y=GRID_Y+r*CELL_H;
    if(mx>=x&&mx<x+CELL_W&&my>=y&&my<y+CELL_H){placeAt(r,c);return;}
  }
  for(let i=suns.length-1;i>=0;i--){
    const s=suns[i];
    if(mx>=s.x-18&&mx<=s.x+18&&my>=s.y-18&&my<=s.y+18){
      sun++;sunVal.textContent=sun;suns.splice(i,1);return;
    }
  }
});

function placeAt(r,c){
  if(!selected||grid[r][c]||sun<costs[selected])return;
  sun-=costs[selected];sunVal.textContent=sun;
  if(selected==='pea')grid[r][c]={type:'pea',hp:5,shootTimer:0};
  if(selected==='uppea')grid[r][c]={type:'uppea',hp:6,shootTimer:0};
  if(selected==='sun')grid[r][c]={type:'sunflower',hp:4,collectTimer:0};
  if(selected==='pie')grid[r][c]={type:'pie',hp:1};
}

function spawnSun(){const x=GRID_X+Math.random()*(COLS*CELL_W);suns.push({x,y:-20,vy:0.15,emoji:'‚òÄÔ∏è'});}
function spawnZombie(){
  const r=Math.floor(Math.random()*ROWS),y=GRID_Y+r*CELL_H+CELL_H/2;
  const x=canvas.width+40,speed=0.3+(currentWave-1)*0.06;
  const types=['üßü','üßü‚Äç‚ôÄÔ∏è','üßü‚Äç‚ôÇÔ∏è'],emoji=types[Math.floor(Math.random()*types.length)];
  zombies.push({x,y,r,speed,hp:3,emoji,attackTimer:0});
  zombiesSpawned++;
}

function firePea(r,c,upgraded){
  const sx=GRID_X+c*CELL_W+CELL_W-10,sy=GRID_Y+r*CELL_H+CELL_H/2;
  projectiles.push({x:sx,y:sy,vx:0.6,row:r,dmg:upgraded?2:1});
}

function triggerTractor(row){if(!tractor)tractor={row,x:-120};}

function update(dt){
  lastSunDrop+=dt;
  if(lastSunDrop>2000){spawnSun();lastSunDrop=0;}
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const p=grid[r][c];
    if(p?.type==='sunflower'){p.collectTimer+=dt;if(p.collectTimer>=3000){
      p.collectTimer=0;suns.push({x:GRID_X+c*CELL_W+CELL_W/2,y:GRID_Y+r*CELL_H+10,vy:0.12,emoji:'‚òÄÔ∏è'});
    }}
  }
  if(preparing){
    status.textContent=`Status: Preparing (${Math.ceil(prepareTimer/1000)}s)`;
    prepareTimer-=dt;
    if(prepareTimer<=0){
      preparing=false;waveActive=true;
      zombiesSpawned=0;zombiesToSpawn=6+Math.floor((currentWave-1)*0.8);
      lastZombieSpawn=0;
    }
  }else if(waveActive){
    status.textContent='Status: Wave Active';
    lastZombieSpawn+=dt;
    if(lastZombieSpawn>Math.max(600,4000-(currentWave-1)*180)&&zombiesSpawned<zombiesToSpawn){
      spawnZombie();lastZombieSpawn=0;
    }
    if(zombiesSpawned>=zombiesToSpawn&&zombies.length===0){
      waveActive=false;
      if(currentWave>=TOTAL_WAVES){status.textContent='You Win!';}
      else{currentWave++;waveText.textContent=`Wave: ${currentWave} / ${TOTAL_WAVES}`;
        preparing=true;prepareTimer=5000;}
    }
  }
  for(let i=suns.length-1;i>=0;i++){const s=suns[i];s.y+=s.vy*dt;if(s.y>canvas.height-30)s.y=canvas.height-30;}
  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i];p.x+=p.vx*dt;
    for(let j=zombies.length-1;j>=0;j--){
      const z=zombies[j];
      if(z.r===p.row&&Math.abs(p.x-z.x)<18){z.hp-=p.dmg;projectiles.splice(i,1);if(z.hp<=0)zombies.splice(j,1);break;}
    }
    if(projectiles[i]&&p.x>canvas.width+50)projectiles.splice(i,1);
  }
  for(let i=zombies.length-1;i>=0;i--){
    const z=zombies[i];z.x-=z.speed*dt;
    if(z.x<-40){triggerTractor(z.r);zombies.splice(i,1);continue;}
    const col=Math.floor((z.x-GRID_X)/CELL_W);
    for(let dc=0;dc<=1;dc++){
      const cc=col-dc;if(cc>=0&&cc<COLS){
        const p=grid[z.r][cc];
        if(p&&p.type!=='pie'){p.attackAccum=(p.attackAccum||0)+dt;
          if(p.attackAccum>=3000){grid[z.r][cc]=null;}
          break;
        }
      }
    }
    for(let c=0;c<COLS;c++){
      const p=grid[z.r][c];
      if(p?.type==='pie'){
        const pieX=GRID_X+c*CELL_W+CELL_W/2;
        if(Math.abs(z.x-pieX)<CELL_W+10){grid[z.r][c]=null;zombies.splice(i,1);break;}
      }
    }
  }
  if(tractor){
    tractor.x+=0.6*dt;
    for(let i=zombies.length-1;i>=0;i--){
      const z=zombies[i];
      if(z.r===tractor.row&&z.x<tractor.x+120&&z.x>tractor.x-60)zombies.splice(i,1);
    }
    if(tractor.x>canvas.width+200)tractor=null;
  }
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const p=grid[r][c];
    if(p?.type==='pea'||p?.type==='uppea'){
      p.shootTimer+=dt;
      const cd=(p.type==='uppea')?1500:3000;
      if(p.shootTimer>=cd){
        p.shootTimer=0;
        if(zombies.some(z=>z.r===r&&z.x>GRID_X+c*CELL_W))firePea(r,c,p.type==='uppea');
      }
    }
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='rgba(0,0,0,0.2)';
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const x=GRID_X+c*CELL_W,y=GRID_Y+r*CELL_H;
    ctx.strokeRect(x,y,CELL_W-2,CELL_H-2);
    const p=grid[r][c];
    if(p){
      ctx.font='40px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
      if(p.type==='pea'||p.type==='uppea'){
        if(p.type==='uppea'){ctx.strokeStyle='red';ctx.lineWidth=3;ctx.strokeRect(x+5,y+5,CELL_W-10,CELL_H-10);}
        ctx.fillText('ü´õ',x+CELL_W/2,y+CELL_H/2);
      }
      if(p.type==='sunflower')ctx.fillText('üåª',x+CELL_W/2,y+CELL_H/2);
      if(p.type==='pie')ctx.fillText('ü•ß',x+CELL_W/2,y+CELL_H/2);
    }
  }
  for(const pr of projectiles){
    ctx.beginPath();ctx.fillStyle='green';ctx.arc(pr.x,pr.y,8,0,Math.PI*2);ctx.fill();
  }
  for(const z of zombies){ctx.font='36px Arial';ctx.fillText(z.emoji,z.x,GRID_Y+z.r*CELL_H+CELL_H/2);}
  for(const s of suns){ctx.font='28px Arial';ctx.fillText(s.emoji,s.x,s.y);}
  if(tractor){ctx.save();ctx.translate(tractor.x,GRID_Y+tractor.row*CELL_H+CELL_H/2);ctx.scale(-1,1);ctx.font='48px Arial';ctx.fillText('üöú',0,0);ctx.restore();}
}

function loop(now){const dt=now-lastTick;lastTick=now;update(dt);draw();requestAnimationFrame(loop);}
waveText.textContent=`Wave: ${currentWave} / ${TOTAL_WAVES}`;requestAnimationFrame(loop);
</script>
</body>
</html>
